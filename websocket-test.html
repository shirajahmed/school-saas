<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Notification Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 10px 0; }
        .notification { background: #e3f2fd; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #2196f3; }
        .error { background: #ffebee; border-left-color: #f44336; }
        .success { background: #e8f5e8; border-left-color: #4caf50; }
        button { background: #2196f3; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1976d2; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
        .status { font-weight: bold; }
        .connected { color: #4caf50; }
        .disconnected { color: #f44336; }
        #notifications { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîî WebSocket Notification Test</h1>
    
    <div class="container">
        <h3>Connection</h3>
        <input type="text" id="token" placeholder="Enter JWT Token" style="width: 400px;">
        <br>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <p>Status: <span id="status" class="status disconnected">Disconnected</span></p>
        <p>Unread Count: <span id="unreadCount">0</span></p>
        <p>Connected Users: <span id="connectedUsers">0</span></p>
    </div>

    <div class="container">
        <h3>Actions</h3>
        <button onclick="subscribePersonal()">Subscribe Personal</button>
        <button onclick="subscribeSchool()">Subscribe School</button>
        <button onclick="getUnreadCount()">Get Unread Count</button>
        <button onclick="clearNotifications()">Clear Notifications</button>
    </div>

    <div class="container">
        <h3>üì± Real-time Notifications</h3>
        <div id="notifications"></div>
    </div>

    <div class="container">
        <h3>üìã Connection Log</h3>
        <div id="log"></div>
    </div>

    <script>
        let socket = null;
        let isConnected = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'notification';
            logDiv.innerHTML = `<div class="${className}">[${timestamp}] ${message}</div>` + logDiv.innerHTML;
        }

        function updateStatus(connected) {
            isConnected = connected;
            const statusEl = document.getElementById('status');
            statusEl.textContent = connected ? 'Connected' : 'Disconnected';
            statusEl.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function connect() {
            const token = document.getElementById('token').value;
            if (!token) {
                alert('Please enter JWT token first');
                return;
            }

            if (socket) {
                socket.disconnect();
            }

            log('üîå Attempting to connect to WebSocket...', 'info');

            socket = io('http://localhost:3001', {
                auth: { token: token },
                transports: ['websocket', 'polling'],
                upgrade: true,
                rememberUpgrade: true,
                timeout: 20000,
                forceNew: true
            });

            socket.on('connect', () => {
                updateStatus(true);
                log('‚úÖ Connected to WebSocket server', 'success');
            });

            socket.on('disconnect', (reason) => {
                updateStatus(false);
                log(`‚ùå Disconnected from WebSocket server: ${reason}`, 'error');
            });

            socket.on('connect_error', (error) => {
                log(`‚ùå Connection error: ${error.message}`, 'error');
                log(`üîß Trying to reconnect...`, 'info');
                updateStatus(false);
            });

            socket.on('reconnect', (attemptNumber) => {
                log(`üîÑ Reconnected after ${attemptNumber} attempts`, 'success');
                updateStatus(true);
            });

            socket.on('reconnect_error', (error) => {
                log(`‚ùå Reconnection failed: ${error.message}`, 'error');
            });

            socket.on('connected', (data) => {
                log(`üéâ Authentication successful: ${data.message}`, 'success');
                log(`üë§ User ID: ${data.userId}`, 'info');
            });

            socket.on('notification', (notification) => {
                showNotification(notification);
                log(`üì± New notification: ${notification.title}`, 'success');
                // Auto-update unread count
                setTimeout(getUnreadCount, 500);
            });

            socket.on('announcement', (announcement) => {
                showNotification(announcement, true);
                log(`üì¢ System announcement: ${announcement.title}`, 'success');
            });

            socket.on('unread:count', (data) => {
                document.getElementById('unreadCount').textContent = data.count;
                log(`üìä Unread count: ${data.count}`, 'info');
            });

            socket.on('subscribed', (data) => {
                log(`‚úÖ Subscribed to ${data.type} notifications`, 'success');
            });

            socket.on('marked:read', (data) => {
                log(`‚úÖ Notification marked as read: ${data.deliveryId}`, 'success');
            });

            socket.on('error', (error) => {
                log(`‚ùå Socket error: ${error.message || error}`, 'error');
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            updateStatus(false);
            log('üîå Manually disconnected', 'info');
        }

        function subscribePersonal() {
            if (!socket || !isConnected) {
                alert('Please connect first');
                return;
            }
            socket.emit('subscribe:personal');
            log('üì± Subscribing to personal notifications...', 'info');
        }

        function subscribeSchool() {
            if (!socket || !isConnected) {
                alert('Please connect first');
                return;
            }
            socket.emit('subscribe:school');
            log('üè´ Subscribing to school notifications...', 'info');
        }

        function getUnreadCount() {
            if (!socket || !isConnected) {
                alert('Please connect first');
                return;
            }
            socket.emit('get:unread-count');
            log('üìä Requesting unread count...', 'info');
        }

        function showNotification(notification, isAnnouncement = false) {
            const notificationsDiv = document.getElementById('notifications');
            const timestamp = new Date(notification.timestamp || Date.now()).toLocaleTimeString();
            const type = isAnnouncement ? 'üì¢ ANNOUNCEMENT' : 'üì± NOTIFICATION';
            
            const notificationHtml = `
                <div class="notification ${isAnnouncement ? 'success' : ''}">
                    <strong>${type}</strong><br>
                    <strong>${notification.title}</strong><br>
                    ${notification.message}<br>
                    <small>üìÖ ${timestamp} | Type: ${notification.type || 'ANNOUNCEMENT'}</small>
                    ${notification.id ? `<br><button onclick="markAsRead('${notification.id}')" style="font-size: 12px; padding: 5px 10px;">Mark as Read</button>` : ''}
                </div>
            `;
            
            notificationsDiv.innerHTML = notificationHtml + notificationsDiv.innerHTML;
        }

        function markAsRead(deliveryId) {
            if (!socket || !isConnected) {
                alert('Please connect first');
                return;
            }
            socket.emit('mark:read', { deliveryId });
            log(`üìñ Marking notification as read: ${deliveryId}`, 'info');
        }

        function clearNotifications() {
            document.getElementById('notifications').innerHTML = '';
            log('üßπ Notifications cleared', 'info');
        }

        // Auto-connect if token is in URL
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                document.getElementById('token').value = token;
                log('üîë Token loaded from URL', 'info');
            }
        };
    </script>
</body>
</html>
